# handlers/gpt_handler.py

from openai import OpenAI
from config import OPENAI_API_KEY, ADMIN_IDS
from handlers.admin_handlers import send_admin_panel
import logging
from aiogram import Dispatcher, types

client = OpenAI(api_key=OPENAI_API_KEY)

rules_summary = """
–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–Ω–∫—É—Ä—Å–∞ *¬´–≠—Å—Ç–∞—Ñ–µ—Ç–∞ –ü–æ–±–µ–¥—ã. –û—Ç –ø–∞–º—è—Ç–Ω–∏–∫–∞ –∫ –ø–∞–º—è—Ç–∏¬ª*, –ø—Ä–∏—É—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –∫ 80-–ª–µ—Ç–∏—é –ü–æ–±–µ–¥—ã –≤ –í–µ–ª–∏–∫–æ–π –û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–π–Ω–µ –∏ –ì–æ–¥—É –ó–∞—â–∏—Ç–Ω–∏–∫–∞ –û—Ç–µ—á–µ—Å—Ç–≤–∞. –ö–æ–Ω–∫—É—Ä—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å *1 –∞–ø—Ä–µ–ª—è –ø–æ 30 –Ω–æ—è–±—Ä—è 2025 –≥–æ–¥–∞*.

üìç *–£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è:*
- –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –º–æ–∂–µ—Ç –ª—é–±–æ–π —á–µ–ª–æ–≤–µ–∫, –≤—ã–ø–æ–ª–Ω–∏–≤—à–∏–π —É—Å–ª–æ–≤–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞.
- –ù—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ —É –ø–∞–º—è—Ç–Ω–∏–∫–∞ (–∏–ª–∏ –∑–Ω–∞–∫–æ–≤–æ–≥–æ –º–µ—Å—Ç–∞), –ø–æ—Å–≤—è—â—ë–Ω–Ω–æ–≥–æ –∑–∞—â–∏—Ç–Ω–∏–∫–∞–º –û—Ç–µ—á–µ—Å—Ç–≤–∞.
- –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö —Å —Ö–µ—à—Ç–µ–≥–æ–º `#–û—Ç–ü–∞–º—è—Ç–Ω–∏–∫–∞–ö–ü–∞–º—è—Ç–∏`
- –£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –∏ –º–µ—Å—Ç–æ —Å—ä—ë–º–∫–∏, –∏ –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞—Ç—å –æ–±—ä–µ–∫—Ç.
- –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç: @MemoryStone2025Bot

üéØ *–¶–µ–ª—å –∫–æ–Ω–∫—É—Ä—Å–∞:*
–ü–æ–ø—É–ª—è—Ä–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –æ –∑–∞—â–∏—Ç–Ω–∏–∫–∞—Ö –û—Ç–µ—á–µ—Å—Ç–≤–∞, —Ä–∞–∑–≤–∏—Ç–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∫ –ø–∞–º—è—Ç–Ω—ã–º –º–µ—Å—Ç–∞–º, —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –ø–∞—Ç—Ä–∏–æ—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥—É—Ö–∞.

üèÜ *–ü—Ä–∏–∑—ã:*
- –ó–∞ –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –±–∞–ª–ª—ã.
- –ù—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å *80 –±–∞–ª–ª–æ–≤*, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ —Ä–æ–∑—ã–≥—Ä—ã—à –ø—Ä–∏–∑–æ–≤.
- –û—Å–Ω–æ–≤–Ω–æ–π —Ä–æ–∑—ã–≥—Ä—ã—à ‚Äî *9 –¥–µ–∫–∞–±—Ä—è 2025 –≥–æ–¥–∞*, –≤ –î–µ–Ω—å –ì–µ—Ä–æ–µ–≤ –û—Ç–µ—á–µ—Å—Ç–≤–∞.
- –¢–∞–∫–∂–µ –±—É–¥—É—Ç *–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏* –∑–∞ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.

üìä *–°–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤:*
- –ü–∞–º—è—Ç–Ω–∏–∫–∏ –≤–æ–µ–Ω–Ω—ã–º —Å–æ–±—ã—Ç–∏—è–º ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ü–∞–º—è—Ç–Ω–∏–∫–∏ —Ç—Ä—É–¥–æ–≤–æ–º—É –ø–æ–¥–≤–∏–≥—É ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ò–º–µ–Ω–Ω—ã–µ –ø–∞–º—è—Ç–Ω–∏–∫–∏ –ì–µ—Ä–æ—è–º –°–æ–≤–µ—Ç—Å–∫–æ–≥–æ –°–æ—é–∑–∞ ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ü–∞–º—è—Ç–Ω–∏–∫–∏ –≥–æ—Ä–æ–¥–∞–º –í–æ–∏–Ω—Å–∫–æ–π –∏–ª–∏ –¢—Ä—É–¥–æ–≤–æ–π –°–ª–∞–≤—ã ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ú—É–∑–µ–π–Ω—ã–µ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏ (–≤–æ–π–Ω–∞, —Ç—Ä—É–¥) ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ü–∞–º—è—Ç–Ω—ã–µ –¥–æ—Å–∫–∏ –∑–∞—â–∏—Ç–Ω–∏–∫–∞–º, —Ç—Ä—É–¥—É, –≤–æ–π–Ω–µ ‚Äî 4 –±–∞–ª–ª–∞

üìå *–ö–∞–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ–¥—Ö–æ–¥—è—â–∏–º–∏:*
- –í—Å—ë, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –∑–∞—â–∏—Ç–æ–π –û—Ç–µ—á–µ—Å—Ç–≤–∞, –≥–µ—Ä–æ–∏–∑–º–æ–º, —Ç—Ä—É–¥–æ–º, –≤–æ–µ–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π.
- –ü–æ–¥—Ö–æ–¥—è—Ç –ø–∞–º—è—Ç–Ω–∏–∫–∏, –¥–æ—Å–∫–∏, –º—É–∑–µ–∏, –º–µ–º–æ—Ä–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –í–û–í –∏ –¥—Ä—É–≥–∏–º–∏ –≤–æ–µ–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏.
- –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ —É—á–∞—Å—Ç–Ω–∏–∫—É —Å–≤–µ—Ä–∏—Ç—å—Å—è —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å —É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤.

üë• *–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã –∫–æ–Ω–∫—É—Ä—Å–∞:*
- –ö–∞–Ω–æ–≤ –ú–∏—Ö–∞–∏–ª –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á (@isilgan)
- –û–û–û ¬´–ì–æ—Ä–æ–¥—Å–∫–æ–π —Ä–∞–¥–∏–æ—É–∑–µ–ª¬ª

üì£ *–ì–¥–µ —á–∏—Ç–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –æ –∫–æ–Ω–∫—É—Ä—Å–µ:*
- VK: [–°–Ω–µ–∂–∏–Ω—Å–∫.–°–û–ë–´–¢–ò–Ø](https://vk.com/snzsegodnya)
- Telegram-–±–æ—Ç: @MemoryStone2025Bot

üìå *–í–∞–∂–Ω–æ:*
- –§–æ—Ç–æ –∏ –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–¥–µ–ª–∞–Ω—ã *–ø–æ—Å–ª–µ 1 –∞–ø—Ä–µ–ª—è 2025 –≥–æ–¥–∞*.
- –£—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏.

üí¨ *–ö–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å:*
- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –≥–æ–≤–æ—Ä–∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏.
- –î–µ–ª–∞–π —Ç–µ–∫—Å—Ç —É–¥–æ–±–Ω—ã–º: —Ä–∞–∑–¥–µ–ª—è–π –º—ã—Å–ª–∏ –Ω–∞ –∞–±–∑–∞—Ü—ã.
- –ò—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç**, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã–¥–µ–ª–∏—Ç—å –≤–∞–∂–Ω–æ–µ.
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–∑—ã–≤–∞–π —Ö–µ—à—Ç–µ–≥ `#–û—Ç–ü–∞–º—è—Ç–Ω–∏–∫–∞–ö–ü–∞–º—è—Ç–∏`, –Ω–µ –∑–∞–º–µ–Ω—è–π –µ–≥–æ —Å–ª–æ–≤–∞–º–∏ —Ç–∏–ø–∞ "–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π".
- –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å —Ç–æ—á–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å ‚Äî —Å–∫–∞–∂–∏, —á—Ç–æ –ª—É—á—à–µ —É—Ç–æ—á–Ω–∏—Ç—å —É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤: @isilgan

–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º ‚Äî –æ–±—ä—è—Å–Ω—è–π, –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π!
"""

async def ask_gpt(message_or_text):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ GPT. –ú–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∫–∞–∫ –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç–∞–∫ –∏ —Å—Ç—Ä–æ–∫—É —Ç–µ–∫—Å—Ç–∞.
    """
    try:
        if isinstance(message_or_text, str):
            text = message_or_text
            user_id = None
        else:
            text = message_or_text.text
            user_id = message_or_text.from_user.id

        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": rules_summary},
                {"role": "user", "content": text}
            ],
            max_tokens=400
        )
        answer = response.choices[0].message.content

        # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        if not isinstance(message_or_text, str):
            await message_or_text.answer(answer, parse_mode='Markdown')
            # –ï—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            if user_id in ADMIN_IDS:
                await send_admin_panel(message_or_text)

        return answer
    except Exception as e:
        logging.error(f"GPT ERROR: {e}")
        if not isinstance(message_or_text, str):
            await message_or_text.answer(
                "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–æ–∫–∞ –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º: @isilgan", 
                parse_mode='Markdown'
            )
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–æ–∫–∞ –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ —Ä–µ–∂–∏–º–µ –≤–æ–ø—Ä–æ—Å–∞
async def handle_media_question(message: types.Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ —Ä–µ–∂–∏–º–µ –≤–æ–ø—Ä–æ—Å–∞ –∫ GPT"""
    media_type = "—Ñ–æ—Ç–æ" if message.photo else "–≤–∏–¥–µ–æ" if message.video else "–∞—É–¥–∏–æ" if message.audio else "—Ñ–∞–π–ª"
    
    await message.answer(
        f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å {media_type} –Ω–∞–ø—Ä—è–º—É—é. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å –æ –∫–æ–Ω–∫—É—Ä—Å–µ –∏–ª–∏ –ø—Ä–∞–≤–∏–ª–∞—Ö, "
        f"–ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º, –∏ —è —Å —Ä–∞–¥–æ—Å—Ç—å—é –æ—Ç–≤–µ—á—É!",
        parse_mode='Markdown'
    )

def register_gpt_handler(dp: Dispatcher):
    @dp.message_handler(lambda message: "?" in message.text, content_types=types.ContentTypes.TEXT)
    async def handle_gpt_question(message: types.Message):
        await ask_gpt(message)
        
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –≤–æ–ø—Ä–æ—Å–∞
    @dp.message_handler(
        content_types=[
            types.ContentType.PHOTO, 
            types.ContentType.VIDEO, 
            types.ContentType.AUDIO, 
            types.ContentType.DOCUMENT,
            types.ContentType.VOICE,
            types.ContentType.STICKER
        ]
    )
    async def handle_media_in_gpt(message: types.Message):
        await handle_media_question(message)
