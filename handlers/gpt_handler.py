# handlers/gpt_handler.py

from openai import OpenAI
from config import OPENAI_API_KEY, ADMIN_IDS
from handlers.admin_handlers import send_admin_panel
import logging
from aiogram import Dispatcher, types

client = OpenAI(api_key=OPENAI_API_KEY)

rules_summary = """
–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–Ω–∫—É—Ä—Å–∞ *¬´–≠—Å—Ç–∞—Ñ–µ—Ç–∞ –ü–æ–±–µ–¥—ã. –û—Ç –ø–∞–º—è—Ç–Ω–∏–∫–∞ –∫ –ø–∞–º—è—Ç–∏¬ª*, –ø—Ä–∏—É—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –∫ 80-–ª–µ—Ç–∏—é –ü–æ–±–µ–¥—ã –≤ –í–µ–ª–∏–∫–æ–π –û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–π–Ω–µ –∏ –ì–æ–¥—É –ó–∞—â–∏—Ç–Ω–∏–∫–∞ –û—Ç–µ—á–µ—Å—Ç–≤–∞. –ö–æ–Ω–∫—É—Ä—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å *1 –∞–ø—Ä–µ–ª—è –ø–æ 30 –Ω–æ—è–±—Ä—è 2025 –≥–æ–¥–∞*.

üìç *–£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è:*
- –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –º–æ–∂–µ—Ç –ª—é–±–æ–π —á–µ–ª–æ–≤–µ–∫.
- –ù—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ —É –ø–∞–º—è—Ç–Ω–∏–∫–∞ –∏–ª–∏ –æ–±—ä–µ–∫—Ç–∞, –ø–æ—Å–≤—è—â—ë–Ω–Ω–æ–≥–æ –∑–∞—â–∏—Ç–µ –û—Ç–µ—á–µ—Å—Ç–≤–∞.
- –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö —Å —Ö–µ—à—Ç–µ–≥–æ–º `#–û—Ç–ü–∞–º—è—Ç–Ω–∏–∫–∞–ö–ü–∞–º—è—Ç–∏`.
- –£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –∏ –º–µ—Å—Ç–æ —Å—ä—ë–º–∫–∏, –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞—Ç—å –æ–±—ä–µ–∫—Ç.
- –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É **—á–µ—Ä–µ–∑ —ç—Ç–æ—Ç Telegram-–±–æ—Ç: @MemoryStone2025Bot**.

üï∞ *–í–∞–∂–Ω–æ:* 
- –§–æ—Ç–æ/–≤–∏–¥–µ–æ –∏ –ø–æ—Å—Ç –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–¥–µ–ª–∞–Ω—ã *–≤ –ø–µ—Ä–∏–æ–¥ —Å 1 –∞–ø—Ä–µ–ª—è –ø–æ 30 –Ω–æ—è–±—Ä—è 2025 –≥–æ–¥–∞*.
- –ü–æ—Å—Ç—ã —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–º–∏ –¥–æ 1 –∞–ø—Ä–µ–ª—è, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è.
- –£—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏.

üéØ *–¶–µ–ª—å –∫–æ–Ω–∫—É—Ä—Å–∞:*
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–º—è—Ç—å –æ –∑–∞—â–∏—Ç–Ω–∏–∫–∞—Ö –û—Ç–µ—á–µ—Å—Ç–≤–∞, –ø—Ä–æ–±—É–¥–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø–∞–º—è—Ç–Ω—ã–º –º–µ—Å—Ç–∞–º –∏ —Ä–∞–∑–≤–∏—Ç—å –ø–∞—Ç—Ä–∏–æ—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–Ω–∞–Ω–∏–µ.

üèÜ *–ü—Ä–∏–∑—ã –∏ –±–∞–ª–ª—ã:*
- –ó–∞ –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –±–∞–ª–ª—ã.
- –ß—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ, –Ω—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å *80 –±–∞–ª–ª–æ–≤*.
- –ì–ª–∞–≤–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à ‚Äî *9 –¥–µ–∫–∞–±—Ä—è 2025 –≥–æ–¥–∞*, –≤ –î–µ–Ω—å –ì–µ—Ä–æ–µ–≤ –û—Ç–µ—á–µ—Å—Ç–≤–∞.
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑—ã ‚Äî –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å.

üìä *–°–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è:*
- –ü–∞–º—è—Ç–Ω–∏–∫–∏ –≤–æ–µ–Ω–Ω—ã–º —Å–æ–±—ã—Ç–∏—è–º ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ü–∞–º—è—Ç–Ω–∏–∫–∏ —Ç—Ä—É–¥–æ–≤–æ–º—É –ø–æ–¥–≤–∏–≥—É ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ò–º–µ–Ω–Ω—ã–µ –ø–∞–º—è—Ç–Ω–∏–∫–∏ –ì–µ—Ä–æ—è–º –°–æ–≤–µ—Ç—Å–∫–æ–≥–æ –°–æ—é–∑–∞ ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ú—É–∑–µ–π–Ω—ã–µ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏ (—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –≤–æ–π–Ω–æ–π –∏ —Ç—Ä—É–¥–æ–º) ‚Äî 8 –±–∞–ª–ª–æ–≤
- –ü–∞–º—è—Ç–Ω—ã–µ –¥–æ—Å–∫–∏, –ø–æ—Å–≤—è—â—ë–Ω–Ω—ã–µ –≥–µ—Ä–æ—è–º, –≤–æ–π–Ω–µ, —Ç—Ä—É–¥—É ‚Äî 4 –±–∞–ª–ª–∞

üö´ *–ß—Ç–æ –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è:*
- –§–æ—Ç–æ —Å –∫–Ω–∏–≥–∞–º–∏, –¥–µ—Ä–µ–≤—å—è–º–∏, –±—ã—Ç–æ–≤—ã–º–∏ –≤–µ—â–∞–º–∏, –±–µ–∑ –ø–∞–º—è—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
- –°–∏–º–≤–æ–ª–∏–∫–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Ñ–ª–∞–≥, –º–µ–¥–∞–ª—å –∏ —Ç.–ø.)

‚úÖ *–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ–¥—Ö–æ–¥—è—â–∏–º:*
- –ü–∞–º—è—Ç–Ω–∏–∫–∏, –º–µ–º–æ—Ä–∏–∞–ª—å–Ω—ã–µ –¥–æ—Å–∫–∏, –º—É–∑–µ–π–Ω—ã–µ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏, –º–µ–º–æ—Ä–∏–∞–ª—ã, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–µ–ª—ã –∏ –æ–±—ä–µ–∫—Ç—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–∞–º—è—Ç—å—é –æ –∑–∞—â–∏—Ç–µ –†–æ–¥–∏–Ω—ã, –≥–µ—Ä–æ—è—Ö, –≤–æ–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö.

üì£ *–ì–¥–µ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏:*
- –í–ö–æ–Ω—Ç–∞–∫—Ç–µ: [–°–Ω–µ–∂–∏–Ω—Å–∫.–°–û–ë–´–¢–ò–Ø](https://vk.com/snzsegodnya)
- Telegram-–±–æ—Ç: @MemoryStone2025Bot

üë• *–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã –∫–æ–Ω–∫—É—Ä—Å–∞:*
- –ö–∞–Ω–æ–≤ –ú–∏—Ö–∞–∏–ª –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á ‚Äî [@isilgan](https://t.me/isilgan)
- –û–û–û ¬´–ì–æ—Ä–æ–¥—Å–∫–æ–π —Ä–∞–¥–∏–æ—É–∑–µ–ª¬ª

üí¨ *–ö–∞–∫ —Ç—ã –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å:*
- –û—Ç–≤–µ—á–∞–π –≤–µ–∂–ª–∏–≤–æ, –ø–æ–Ω—è—Ç–Ω–æ –∏ –ø–æ —Ç–µ–º–µ.
- –†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã.
- –í—ã–¥–µ–ª—è–π –≤–∞–∂–Ω–æ–µ **–∂–∏—Ä–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–∞—Ç—ã, —Ö–µ—à—Ç–µ–≥, —á–∏—Å–ª–∞).
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π `#–û—Ç–ü–∞–º—è—Ç–Ω–∏–∫–∞–ö–ü–∞–º—è—Ç–∏` —è–≤–Ω–æ, –Ω–µ –∑–∞–º–µ–Ω—è–π –æ–ø–∏—Å–∞–Ω–∏–µ–º.
- –ù–µ –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —Ç–µ–º–∞–º, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å –∫–æ–Ω–∫—É—Ä—Å–æ–º (–∑–¥–æ—Ä–æ–≤—å–µ, —Ñ–∏–Ω–∞–Ω—Å—ã –∏ —Ç.–¥.).
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —á–µ–ª–æ–≤–µ–∫–µ –∏–ª–∏ –ø–∞–º—è—Ç–Ω–∏–∫–µ, –∏ —Ç—ã –Ω–µ —É–≤–µ—Ä–µ–Ω–∞ ‚Äî –ª—É—á—à–µ –≤–µ–∂–ª–∏–≤–æ —Å–∫–∞–∂–∏, —á—Ç–æ –Ω–µ —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—à—å —Ç–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —á—ë–º-—Ç–æ, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–µ–º—Å—è –∫ –∫–æ–Ω–∫—É—Ä—Å—É ‚Äî –º—è–≥–∫–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–æ–Ω–∫—É—Ä—Å–Ω—ã–µ —Ç–µ–º—ã.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ *¬´–ø—Ä–æ–¥–æ–ª–∂—É...¬ª* –∏–ª–∏ *¬´—Å–º. —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ¬ª*. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–∏:
  *¬´–ï—Å–ª–∏ —É –≤–∞—Å –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø—Ä–æ—Å—Ç–æ —É—Ç–æ—á–Ω–∏—Ç–µ, –∏ —è –ø–æ–º–æ–≥—É!¬ª*

–¢—ã —Å–æ–∑–¥–∞–Ω–∞, —á—Ç–æ–±—ã –ø–æ–º–æ–≥–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º: –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π, –Ω–∞–ø—Ä–∞–≤–ª—è–π ‚Äî –∏ –≤—Å–µ–≥–¥–∞ —Å —É–≤–∞–∂–µ–Ω–∏–µ–º üíô
"""

async def ask_gpt(message_or_text):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ GPT. –ú–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∫–∞–∫ –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç–∞–∫ –∏ —Å—Ç—Ä–æ–∫—É —Ç–µ–∫—Å—Ç–∞.
    """
    try:
        if isinstance(message_or_text, str):
            text = message_or_text
            user_id = None
        else:
            text = message_or_text.text
            user_id = message_or_text.from_user.id

        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": rules_summary},
                {"role": "user", "content": text}
            ],
            max_tokens=600
        )
        answer = response.choices[0].message.content

        # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        if not isinstance(message_or_text, str):
            await message_or_text.answer(answer, parse_mode='Markdown')
            if user_id in ADMIN_IDS:
                await send_admin_panel(message_or_text)

        return answer
    except Exception as e:
        logging.error(f"GPT ERROR: {e}")
        if not isinstance(message_or_text, str):
            await message_or_text.answer(
                "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–æ–∫–∞ –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É: @isilgan",
                parse_mode='Markdown'
            )
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–æ–∫–∞ –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ —Ä–µ–∂–∏–º–µ –≤–æ–ø—Ä–æ—Å–∞
async def handle_media_question(message: types.Message):
    media_type = "—Ñ–æ—Ç–æ" if message.photo else "–≤–∏–¥–µ–æ" if message.video else "–∞—É–¥–∏–æ" if message.audio else "—Ñ–∞–π–ª"
    await message.answer(
        f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å {media_type} –Ω–∞–ø—Ä—è–º—É—é.\n"
        f"–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å –æ –∫–æ–Ω–∫—É—Ä—Å–µ –∏–ª–∏ –ø—Ä–∞–≤–∏–ª–∞—Ö, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º ‚Äî –∏ —è —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–≥—É!",
        parse_mode='Markdown'
    )

def register_gpt_handler(dp: Dispatcher):
    @dp.message_handler(lambda message: "?" in message.text, content_types=types.ContentTypes.TEXT)
    async def handle_gpt_question(message: types.Message):
        await ask_gpt(message)

    @dp.message_handler(
        content_types=[
            types.ContentType.PHOTO,
            types.ContentType.VIDEO,
            types.ContentType.AUDIO,
            types.ContentType.DOCUMENT,
            types.ContentType.VOICE,
            types.ContentType.STICKER
        ]
    )
    async def handle_media_in_gpt(message: types.Message):
        await handle_media_question(message)
